name: Daily Subscription Converter

on:
  schedule:
    - cron: '30 5 * * *'
    - cron: '30 17 * * *'
  push:
  workflow_dispatch:

jobs:
  convert_and_push:
    runs-on: ubuntu-latest # ุงุฒ ฺฉ ูุญุท ูููฺฉุณ ุงุณุชูุงุฏู ูโฺฉูุฏ.

    steps:
      - name: Checkout repository # ฺฉุฏ ูุฎุฒู ุฑุง ุจู ูุญุท ุงุฌุฑุง ฺฉูพ ูโฺฉูุฏ.
        uses: actions/checkout@v3

      - name: Cache Docker image for subconverter # ฺฉุด ฺฉุฑุฏู ุงูุฌ ุฏุงฺฉุฑ subconverter ุจุฑุง ุงุฌุฑุง ุณุฑุนโุชุฑ
        id: cache-subconverter-docker
        uses: actions/cache@v3
        with:
          path: /var/lib/docker # ูุณุฑ ฺฉู ุงูุฌโูุง ุฏุงฺฉุฑ ุฏุฑ ุขู ุฐุฎุฑู ูโุดููุฏ.
          key: ${{ runner.os }}-docker-${{ hashFiles('**/Dockerfile') }} # ฺฉูุฏ ฺฉุด ุจุฑ ุงุณุงุณ ุณุณุชู ุนุงูู ู ุชุบุฑุงุช Dockerfile (ุงฺฏุฑ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ)
          restore-keys: |
            ${{ runner.os }}-docker-

      - name: Pull subconverter Docker image # ุงุทููุงู ุงุฒ ูุฌูุฏ ุขุฎุฑู ุงูุฌ subconverter
        run: docker pull metacubex/subconverter:latest

      - name: Create base output directory # ุงุฌุงุฏ ูพูุดู ุงุตู ุจุฑุง ุฐุฎุฑู ุฎุฑูุฌโูุง
        run: mkdir -p output_configs

      - name: Install yq # ูุตุจ yq ุจุฑุง ุฎูุงูุฏู ูุงู YAML
        run: sudo snap install yq

      - name: Read subconverter settings # ุฎูุงูุฏู ุชูุธูุงุช ุงุฒ ูุงู YAML
        id: read_settings
        run: |
          SETTINGS_FILE="config/subconverter_settings.yml"
          ADVANCED_PARAMS=""

          if [ -f "$SETTINGS_FILE" ]; then
            echo "ุฎูุงูุฏู ุชูุธูุงุช ุงุฒ: $SETTINGS_FILE"
            # ูุณุช ุชูุงู ูพุงุฑุงูุชุฑูุง ูพุดุฑูุชู ฺฉู ูโุฎูุงูุฏ ุงุฒ ูุงู settings.yml ุจุฎูุงูุฏ
            # ุงู ูุณุช ุจุงุฏ ุจุง ูพุงุฑุงูุชุฑูุง ูพุดุชุจุงู ุดุฏู ุชูุณุท subconverter API ูุทุงุจูุช ุฏุงุดุชู ุจุงุดุฏ.
            PARAMS=(
              "emoji" "add_emoji" "remove_emoji" "append_type" "tfo" "udp" "list" "sort"
              "script" "insert" "scv" "fdn" "expand" "append_info" "prepend" "classic"
              "tls13" "new_name" "ua" "interval" "dev_id" "filename" "exclude" "include" "rename"
            )

            for param in "${PARAMS[@]}"; do
              # ุงุณุชูุงุฏู ุงุฒ yq ุจุฑุง ุฎูุงูุฏู ููุฏุงุฑ ูพุงุฑุงูุชุฑ. 2>/dev/null ุจุฑุง ุณุงฺฉุช ฺฉุฑุฏู ุฎุทุงูุง yq ุฏุฑ ุตูุฑุช ุนุฏู ูุฌูุฏ ูพุงุฑุงูุชุฑ.
              VALUE=$(yq e ".$param" "$SETTINGS_FILE" 2>/dev/null)
              
              # ุจุฑุฑุณ ุงูฺฉู ููุฏุงุฑ null ูุจุงุดุฏ ู ุฎุงู ูุจุงุดุฏ
              if [ "$VALUE" != "null" ] && [ -n "$VALUE" ]; then
                # URL-encode ฺฉุฑุฏู ููุฏุงุฑ ูพุงุฑุงูุชุฑ ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ URL
                ENCODED_VALUE=$(python3 -c 'import urllib.parse; print(urllib.parse.quote(input(), safe=""))' <<< "$VALUE")
                ADVANCED_PARAMS+="&${param}=${ENCODED_VALUE}"
              fi
            done
            echo "ADVANCED_PARAMS=$ADVANCED_PARAMS" >> $GITHUB_OUTPUT
          else
            echo "ูุงู ุชูุธูุงุช '$SETTINGS_FILE' ุงูุช ูุดุฏ. ุงุฒ ุชูุธูุงุช ูพุดโูุฑุถ subconverter ุงุณุชูุงุฏู ูโุดูุฏ."
            echo "ADVANCED_PARAMS=" >> $GITHUB_OUTPUT
          fi

      - name: Start subconverter Docker container # ุฑุงูโุงูุฏุงุฒ ฺฉุงูุชูุฑ subconverter ุฏุฑ ุญุงูุช HTTP ุณุฑูุฑ
        run: |
          docker run -d -p 25500:25500 --name subconverter_instance metacubex/subconverter:latest
          # ุตุจุฑ ฺฉุฑุฏู ุจุฑุง ุขูุงุฏู ุดุฏู ุณุฑูุณ subconverter
          echo "ุตุจุฑ ฺฉุฑุฏู ุจุฑุง ุฑุงูโุงูุฏุงุฒ subconverter..."
          # ููุฏุงุฑ sleep ุฑุง ูโุชูุงู ุจุฑ ุงุณุงุณ ุณุฑุนุช runner ู ุฒูุงู ุฑุงูโุงูุฏุงุฒ subconverter ุชูุธู ฺฉุฑุฏ.
          # 10 ุซุงูู ูุนูููุงู ฺฉุงู ุงุณุช.
          sleep 10 
        
      - name: Process subscription files # ูพุฑุฏุงุฒุด ูุงูโูุง ุณุงุจุณฺฉุฑูพุดู
        run: |
          # ูุณุฑ ูพูุดู ุญุงู ูุงูโูุง ุณุงุจุณฺฉุฑูพุดู ูุฑูุฏ
          INPUT_DIR="input_subs"
          # ูุณุฑ ูพูุดู ุงุตู ุจุฑุง ุฐุฎุฑู ูุงูโูุง ฺฉุงููฺฏ ุชุจุฏู ุดุฏู
          OUTPUT_BASE_DIR="output_configs"
          # ูพุงุฑุงูุชุฑูุง ูพุดุฑูุชู ุงุฒ ูุฑุญูู ูุจู (ุฎุฑูุฌ read_settings)
          ADVANCED_PARAMS="${{ steps.read_settings.outputs.ADVANCED_PARAMS }}"
          
          # ุจุฑุฑุณ ุงูฺฉู ุขุง ูพูุดู ูุฑูุฏ ูุฌูุฏ ุฏุงุฑุฏ ุง ุฎุฑ
          if [ ! -d "$INPUT_DIR" ]; then
            echo "ูพูุดู ูุฑูุฏ '$INPUT_DIR' ุงูุช ูุดุฏ. ูุทูุงู ูุงูโูุง ุณุงุจุณฺฉุฑูพุดู ุฎูุฏ ุฑุง ุฏุฑ ุงู ูพูุดู ูุฑุงุฑ ุฏูุฏ."
            echo "ุนููุงุช ุชุจุฏู ูุชููู ูโุดูุฏ."
            exit 0 # Workflow ุจุง ููููุช ูพุงุงู ูโุงุจุฏ ุงูุง ุนููุงุช ุชุจุฏู ุงูุฌุงู ููโุดูุฏ.
          fi

          # ุญููู ุจุฑุง ูพุฑุฏุงุฒุด ูุฑ ูุงู .txt ุฏุฑ ูพูุดู ูุฑูุฏ
          # ุงุฒ find ุจุฑุง ุงุทููุงู ุงุฒ ุงูุชู ููุท ูุงูโูุง ู ูุฏุฑุช ุจูุชุฑ ูุงูโูุง ุงุณุชูุงุฏู ูโุดูุฏ.
          find "$INPUT_DIR" -maxdepth 1 -type f -name "*.txt" | while read sub_file; do
            echo "ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด ูุงู: $sub_file"
            
            # ุงุณุชุฎุฑุงุฌ ูุงู ูุงู ุจุฏูู ูพุณููุฏ (ูุซูุง "clash" ุงุฒ "clash.txt") ฺฉู ุจู ุนููุงู TARGET_FORMAT ุงุณุชูุงุฏู ูโุดูุฏ
            # sed ุจุฑุง ุญุฐู ูพุณููุฏ .txt ุงุณุชูุงุฏู ูโุดูุฏ.
            TARGET_FORMAT=$(basename "$sub_file" | sed 's/\.txt$//')
            
            # ุงุฌุงุฏ ุฒุฑูพูุดู ุฎุฑูุฌ ุจุฑุง ุงู ูุฑูุช ูุฏู (ูุซูุง output_configs/clash)
            CURRENT_OUTPUT_DIR="${OUTPUT_BASE_DIR}/${TARGET_FORMAT}"
            mkdir -p "$CURRENT_OUTPUT_DIR"
            echo "ุงุฌุงุฏ ูพูุดู ุฎุฑูุฌ: $CURRENT_OUTPUT_DIR"

            LINE_COUNT=0
            # ุฎูุงูุฏู ูุฑ ุฎุท ุงุฒ ูุงู
            while IFS= read -r line; do
              LINE_COUNT=$((LINE_COUNT+1))
              trimmed_line=$(echo "$line" | xargs) # ุญุฐู ูุถุง ุฎุงู ุงุทุฑุงู ุฎุท

              if [ -n "$trimmed_line" ]; then # ุงฺฏุฑ ุฎุท ุฎุงู ูุจุงุดุฏ
                # ุฌุฏุงุณุงุฒ ููฺฉ ู ูุงู ูุงู ุฏูุฎูุงู
                if [[ "$trimmed_line" == *,* ]]; then
                  URL_TO_CONVERT_RAW=$(echo "$trimmed_line" | cut -d',' -f1)
                  CUSTOM_OUTPUT_BASE_NAME=$(echo "$trimmed_line" | cut -d',' -f2-) # ฺฏุฑูุชู ููู ฺุฒ ุจุนุฏ ุงุฒ ุงููู ฺฉุงูุง
                  # ุชูุฒ ฺฉุฑุฏู ูุงู ูุงู ุณูุงุฑุด: ุญุฐู ฺฉุงุฑุงฺฉุชุฑูุง ูุงูุนุชุจุฑ ู ุฌุงฺฏุฒู ุจุง '_'
                  CUSTOM_OUTPUT_BASE_NAME=$(echo "$CUSTOM_OUTPUT_BASE_NAME" | sed 's/[^a-zA-Z0-9._-]/_/g')
                  OUTPUT_FILENAME="${CUSTOM_OUTPUT_BASE_NAME}.yaml"
                else
                  # ุจุงุฒฺฏุดุช ุจู ูุงูโฺฏุฐุงุฑ ูพุดโูุฑุถ ุงฺฏุฑ ฺฉุงูุง ุงูุช ูุดุฏ
                  URL_TO_CONVERT_RAW="$trimmed_line"
                  OUTPUT_FILENAME="${TARGET_FORMAT}_$(printf "%03d" $LINE_COUNT).yaml"
                  echo "  ูุดุฏุงุฑ: ุฎุท #$LINE_COUNT ุฏุฑ ูุงู '$sub_file' ูุฑูุช 'URL,FILENAME' ุฑุง ูุฏุงุฑุฏ. ุงุฒ ูุงู ูพุดโูุฑุถ ุงุณุชูุงุฏู ูโุดูุฏ."
                fi

                # ุจุฑุฑุณ ุงูฺฉู ุจุฎุด URL ูุงูุนุงู ฺฉ URL ุจุงุดุฏ (ฺฉ ุจุฑุฑุณ ุณุงุฏู)
                if [[ "$URL_TO_CONVERT_RAW" =~ ^https?:// ]]; then
                    echo "  ุฏุฑ ุญุงู ุชุจุฏู ููฺฉ #$LINE_COUNT ุงุฒ ูุงู '$sub_file' ุจู ูุฑูุช '$TARGET_FORMAT'..."
                    
                    # URL-encode ฺฉุฑุฏู ููฺฉ ุชฺฉ ุจุง ุงุณุชูุงุฏู ุงุฒ ูพุงุชูู
                    URL_TO_CONVERT=$(python3 -c 'import urllib.parse; print(urllib.parse.quote(input(), safe=""))' <<< "$URL_TO_CONVERT_RAW")
                    
                    OUTPUT_FILE_PATH_IN_WORKSPACE="${CURRENT_OUTPUT_DIR}/${OUTPUT_FILENAME}"

                    # ุณุงุฎุช URL ฺฉุงูู ุจุฑุง ุฏุฑุฎูุงุณุช ุจู API ูุญู subconverter
                    # ุดุงูู ููฺฉ ุณุงุจุณฺฉุฑูพุดู ู ูพุงุฑุงูุชุฑูุง ูพุดุฑูุชู
                    FULL_API_URL="http://localhost:25500/sub?target=${TARGET_FORMAT}&url=${URL_TO_CONVERT}${ADVANCED_PARAMS}"
                    
                    # ุงุฑุณุงู ุฏุฑุฎูุงุณุช curl ุจู subconverter ูุญู ู ุฐุฎุฑู ุฎุฑูุฌ
                    # -s: ุญุงูุช ุณุงฺฉุช (silent)
                    # -S: ููุงุด ุฎุทุงูุง ุญุช ุฏุฑ ุญุงูุช ุณุงฺฉุช
                    # -o: ุฐุฎุฑู ุฎุฑูุฌ ุฏุฑ ูุงู ูุดุฎุต ุดุฏู
                    # ุญุฐู -f ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุชููู Workflow ุฏุฑ ุตูุฑุช ุฎุทุง HTTP (ูุงููุฏ 400)
                    curl -s -S -o "$OUTPUT_FILE_PATH_IN_WORKSPACE" "$FULL_API_URL"
                    
                    # ุจุฑุฑุณ ูุถุนุช ุฎุฑูุฌ ุฏุณุชูุฑ curl
                    CURL_EXIT_CODE=$?
                    if [ "$CURL_EXIT_CODE" -eq 0 ]; then
                      echo "  ุชุจุฏู ููฺฉ #$LINE_COUNT ุจุง ููููุช ุงูุฌุงู ุดุฏ. ุฎุฑูุฌ ุฏุฑ '${OUTPUT_FILE_PATH_IN_WORKSPACE}' ุฐุฎุฑู ุดุฏ."
                    else
                      echo "  ุฎุทุง ุฏุฑ ุชุจุฏู ููฺฉ #$LINE_COUNT ุงุฒ ูุงู '$sub_file' (ฺฉุฏ ุฎุทุง: $CURL_EXIT_CODE). ูุทูุงู ูุงฺฏโูุง GitHub Actions ุฑุง ุจุฑุง ุฌุฒุฆุงุช ุจุดุชุฑ ุจุฑุฑุณ ฺฉูุฏ."
                      echo "  ุงู ููฺฉ ููฺฉู ุงุณุช ูุงูุนุชุจุฑ ุจุงุดุฏ ุง subconverter ูุชูุงูุฏ ุขู ุฑุง ูพุฑุฏุงุฒุด ฺฉูุฏ. ุจู ูพุฑุฏุงุฒุด ููฺฉโูุง ุจุนุฏ ุงุฏุงูู ูโุฏูู."
                      # ูโุชูุงูุฏ ูุญุชูุง ูุงู ุฎุฑูุฌ ุฑุง ุจุง ฺฉ ูพุงู ุฎุทุง ูพุฑ ฺฉูุฏ ุชุง ูุดุฎุต ุจุงุดุฏ ุชุจุฏู ูุงูููู ุจูุฏู ุงุณุช.
                      echo "Error: Failed to convert this link. Check GitHub Actions logs for details." > "$OUTPUT_FILE_PATH_IN_WORKSPACE"
                    fi
                else
                    echo "  ุฎุทุง: ุฎุท #$LINE_COUNT ุฏุฑ ูุงู '$sub_file' ุญุงู URL ูุนุชุจุฑ ูุณุช: '$URL_TO_CONVERT_RAW'. ุงุฒ ุขู ุฑุฏ ูโุดูู."
                fi
              else
                echo "  ุฎุท #$LINE_COUNT ุฏุฑ ูุงู '$sub_file' ุฎุงู ุงุณุช. ุงุฒ ุขู ุฑุฏ ูโุดูู."
              fi
            done < "$sub_file"
            
            # ุงฺฏุฑ ูฺ ููฺฉ ุฏุฑ ูุงู ุงูุช ูุดุฏุ ฺฉ ูพุงู ุจุฏูุฏ
            if [ "$LINE_COUNT" -eq 0 ]; then
              echo "ูุงู '$sub_file' ูฺ ููฺฉ ูุนุชุจุฑ ุจุฑุง ุชุจุฏู ูุฏุงุดุช."
            fi
          done

      - name: Stop subconverter Docker container # ุชููู ฺฉุงูุชูุฑ subconverter
        if: always() # ููุดู ุงุฌุฑุง ุดูุฏุ ุญุช ุงฺฏุฑ ูุฑุงุญู ูุจู ุฎุทุง ุฏุงุดุชู ุจุงุดูุฏ
        run: |
          echo "ุชููู ู ุญุฐู ฺฉุงูุชูุฑ subconverter..."
          docker stop subconverter_instance || true # `|| true` ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุง ุฏุฑ ุตูุฑุช ุนุฏู ูุฌูุฏ ฺฉุงูุชูุฑ
          docker rm subconverter_instance || true # `|| true` ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฎุทุง ุฏุฑ ุตูุฑุช ุนุฏู ูุฌูุฏ ฺฉุงูุชูุฑ

      - name: Configure Git user # ูพฺฉุฑุจูุฏ ุงุทูุงุนุงุช Git ุจุฑุง commit ฺฉุฑุฏู ุชุบุฑุงุช
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate LIST with output list
        run: |
          echo "## Converted Configs" > Output.list
          echo "" >> Output.list
          USER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          find output_configs -type f -name "*.yaml" | sort | while read file; do
            REL_PATH=$(echo "$file" | sed 's|^output_configs/||')
            FILE_NAME=$(basename "$file")
            echo "${FILE_NAME}|https://raw.githubusercontent.com/${USER}/${REPO}/refs/heads/main/output_configs/${REL_PATH}" >> Output.list
          done

      - name: Generate README.md
        run: |
          echo "# ูุณุช ูพุฑุงฺฉุณ ูุง ุงุณุชุฎุฑุงุฌ ุดุฏู ุงุฒ ฺฉุงูฺฉุชูุฑ ูุง ฺฏุชูุงุจ" > README.md
          echo "### ูุณุช ูพุฑุงฺฉุณ ุงุณุชุฎุฑุงุฌ ุดุฏู ุฎุงู" >> README.md
          echo "**ูุงูโูุง ูพฺฉุฑุจูุฏ ุขูุงุฏู ุงุณุชูุงุฏู:**ุจุฑุง proxy-providers" >> README.md

          USER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          EMOJIS=("๐" "๐" "๐" "โก" "๐ก๏ธ")
          IDX=0

          find output_configs -type f -name "*.yaml" | sort | while read file; do
            REL_PATH=$(echo "$file" | sed 's|^output_configs/||')
            FILE_NAME=$(basename "$file")
            EMOJI=${EMOJIS[$((IDX % ${#EMOJIS[@]}))]}
            echo "- [${EMOJI} ${FILE_NAME}](https://raw.githubusercontent.com/${USER}/${REPO}/refs/heads/main/output_configs/${REL_PATH})" >> README.md
            IDX=$((IDX + 1))
          done

          cat << 'EOF' >> README.md

      - name: Configure Git user # ูพฺฉุฑุจูุฏ ุงุทูุงุนุงุช Git ุจุฑุง commit ฺฉุฑุฏู ุชุบุฑุงุช
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes # commit ฺฉุฑุฏู ูุงูโูุง ุชุจุฏู ุดุฏู ู push ุขูโูุง ุจู ูุฎุฒู
        run: |
          # ุจุฑุฑุณ ุงูฺฉู ุขุง ูพูุดู ุฎุฑูุฌ ูุฌูุฏ ุฏุงุฑุฏ ู ุฎุงู ูุณุช
          if [ -d "output_configs" ] && [ "$(ls -A output_configs)" ]; then
            git add output_configs Output.list README.md # ุงุถุงูู ฺฉุฑุฏู ฺฉู ูพูุดู ุฎุฑูุฌ ุจุฑุง commit
            git commit -m "Update converted configs from daily subconverter action" || echo "No changes to commit" # ุงฺฏุฑ ุชุบุฑ ูุจูุฏุ ุฎุทุง ููโุฏูุฏ.
            git push
          else
            echo "ูพูุดู 'output_configs' ุฎุงู ุงุณุช ุง ูุฌูุฏ ูุฏุงุฑุฏ. ูฺ ุชุบุฑ ุจุฑุง commit ูุฌูุฏ ูุฏุงุฑุฏ."
          fi
